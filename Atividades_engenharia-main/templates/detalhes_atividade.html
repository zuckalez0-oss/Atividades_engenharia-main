{% extends "base.html" %}

{% block title %}Detalhes da Atividade - {{ atividade.nome_atividade }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Detalhes da Atividade #{{ atividade.id }}</h2>
        <div>
            <a href="{{ url_for('editar_atividade', atividade_id=atividade.id) }}" class="btn btn-primary">Editar</a>
            <a href="{{ url_for('todas_atividades') }}" class="btn">Voltar para Lista</a>
        </div>
    </div>

    <div class="details-grid">
        <p><strong>Nome da Atividade:</strong> {{ atividade.nome_atividade }}</p>
        <p><strong>Prioridade:</strong> <span class="priority-badge priority-{{ atividade.prioridade.lower() }}">{{ atividade.prioridade }}</span></p>
        <p><strong>Status:</strong> <span class="status-badge status-{{ atividade.status.lower().replace(' ', '-').replace('ã', 'a').replace('ç', 'c') }}">{{ atividade.status }}</span></p>
        <p><strong>Pedido:</strong> {{ atividade.pedido or 'N/A' }}</p>
        <p><strong>Solicitante:</strong> {{ atividade.solicitante or 'N/A' }}</p>
        <p><strong>Centro de Custo:</strong> {{ atividade.centro_de_custo }}</p>
        <p><strong>Data de Criação:</strong> {{ atividade.data_criacao.strftime('%d/%m/%Y %H:%M') }}</p>
        <p><strong>Local de Entrega:</strong> {{ atividade.local_de_entrega or 'N/A' }}</p>
        <p><strong>Obra / Destino:</strong> {{ atividade.obra_destino or 'N/A' }}</p>
        <p><strong>Última Modificação por:</strong> {{ atividade.responsavel_atual }}</p>
        <div class="details-full-width">
            <strong>Observações:</strong>
            <pre>{{ atividade.observacoes or 'Nenhuma observação.' }}</pre>
        </div>
    </div>

    {% if atividade.imagem_anexo %}
    <div class="anexo-container">
        <h3>Anexo</h3>
        <!-- **CORREÇÃO APLICADA AQUI** -->
        <img src="{{ url_for('uploaded_file', folder='atividades', filename=atividade.imagem_anexo) }}" 
             alt="Anexo da atividade" 
             class="anexo-thumbnail"
             id="anexo-thumbnail">
    </div>
    {% endif %}

    {% if current_user.is_admin %}
    <div class="admin-actions">
        <form method="POST" action="{{ url_for('excluir_atividade', atividade_id=atividade.id) }}" onsubmit="return confirm('Tem certeza que deseja excluir esta atividade? Esta ação não pode ser desfeita.');">
            <button type="submit" class="btn btn-danger">Excluir Atividade</button>
        </form>
    </div>
    {% endif %}
</div>

<!-- (Resto do arquivo com histórico e lightbox sem alterações) -->
<div class="card">
    <div class="card-header"><h2>Histórico de Modificações</h2></div>
    <div class="history-timeline">
        {% for hist in atividade.historico %}
        <div class="history-item">
            <div class="history-header"><strong>{{ hist.modificado_por }}</strong> em {{ hist.data_modificacao.strftime('%d/%m/%Y às %H:%M:%S') }}</div>
            <div class="history-body">
                {% if hist.campo_alterado == 'Criação da Atividade' %}
                    <p>{{ hist.valor_novo }}</p>
                {% else %}
                    <p>Alterou o campo <span class="change-field">"{{ hist.campo_alterado }}"</span>:</p>
                    <ul>
                        <li><strong>De:</strong> <pre class="change-values">{{ hist.valor_antigo or 'N/A' }}</pre></li>
                        <li><strong>Para:</strong> <pre class="change-values">{{ hist.valor_novo or 'N/A' }}</pre></li>
                    </ul>
                {% endif %}
            </div>
        </div>
        {% else %}
            <p>Nenhuma modificação registrada ainda.</p>
        {% endfor %}
    </div>
</div>

<div class="lightbox-overlay" id="lightbox-overlay">
    <button class="lightbox-close" id="lightbox-close">&times;</button>
    <div class="lightbox-content"><img src="" alt="Visualização do anexo" class="lightbox-image" id="lightbox-image"></div>
</div>
<script>
    const thumbnail = document.getElementById('anexo-thumbnail');
    const lightboxOverlay = document.getElementById('lightbox-overlay');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxClose = document.getElementById('lightbox-close');
    if (thumbnail) { thumbnail.addEventListener('click', () => { lightboxImage.src = thumbnail.src; lightboxOverlay.style.display = 'flex'; }); }
    if (lightboxClose) { lightboxClose.addEventListener('click', () => { lightboxOverlay.style.display = 'none'; }); }
    if (lightboxOverlay) { lightboxOverlay.addEventListener('click', (event) => { if (event.target === lightboxOverlay) { lightboxOverlay.style.display = 'none'; } }); }
</script>
{% endblock %}
